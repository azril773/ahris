{% extends "hrd_app/master/base.html" %}

{% block breadcrumb %}

<div class="br-pagebody">  

    <div class="br-section-wrapper">
        {% for message in messages %}
        <div class="container-fluid p-0">
            {% if 'safe' in message.tags %}
            <div class="alert alert-info alert-dismissible" role="alert" >
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
                <span class="tx-16"></span>{{ message | safe }}</span>
            </div>
            {% elif message.tags == "error" %}
            <div class="alert alert-danger alert-dismissible" role="alert" >
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
                <span class="tx-16"></span>{{ message | safe }}</span>
            </div>
            {% else %}
            <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert" >
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
                <span class="tx-16"></span>{{ message }}</span>
            </div>
            {% endif %}
        </div>
        {% endfor %}

        <!-- b -->
        <h6 class="tx-gray-800 tx-uppercase tx-bold tx-14 mg-b-10">Ambil Data Mesin</h6>
        <div class="d-flex align-items-center justify-content-start">     
            <div class="mg-r-auto">   
            <!-- Button Proses Data -->

            <!-- Button Cari Data Absen -->

            <!-- Button lainnya -->
            {% include 'hrd_app/master/modul_absensi.html' %} 

            </div>          
        </div>
        {% comment %} </div> {% endcomment %}

        <br>        

        {% csrf_token %}

        <!-- SEMUA -->
        <hr>
        <h5 class="hitam"> # Copy Master - Mesin Lain (semua data)</h5>
        <form action="{% url "cpalldata" %}" method="post">
            {% csrf_token %}
            <div class="d-flex justify-content-start" style="width: 100%;">
                <div class="" style="width: 100%;">
                    <label for="mesin" class="hitam">Mesin</label>
                    <select name="mesin" class="mesin" id="mesin" >
                        <option value="">Pilih Mesin</option>
                        {% for m in mesin %}
                        <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="mesint" class="hitam">Mesin Tujuan</label>
                    <select name="mesint[]" class="mesint" id="mesint" >
                        <option value="">Pilih Mesin Tujuan</option>
                        {% for m in mesin %}
                        <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                &nbsp
                <div class="d-flex align-items-end" style="width: 100%;">
                    <button type="submit" class="btn btn-primary">Proses</button>
                </div>
            </div>
        </form>
        <!-- SEMUA -->


        <!-- BY PEGAWAI -->
        <hr>
        <h5 class="hitam"> # Copy Master - Mesin Lain (by pegawai)</h5>
        <form action="{% url "cppegawai" %}" method="post">
            {% csrf_token %}
            <div class="d-flex justify-content-start" style="width: 100%;">
                <div class="" style="width: 100%;">
                    <label for="mesin" class="hitam">Mesin</label>
                    <select name="mesin" class="mesin" id="mesin" >
                        <option value="">Pilih Mesin</option>
                        {% for m in mesin %}
                            <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="pegawai" class="hitam">Pegawai</label>
                    <select name="pegawai[]" class="pegawai" id="pegawai" >
                        <option value="">Pilih Pegawai</option>
                        {% for m in pegawai %}
                            <option value="{{m.id}}">{{m.nama}} {{m.userid}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="mesint" class="hitam">Mesin Tujuan</label>
                    <select name="mesint[]" class="mesint" id="mesint" >
                        <option value="">Pilih Mesin Tujuan</option>
                        {% for m in mesin %}
                        <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                &nbsp
                <div class="d-flex align-items-end" style="width: 100%;">
                    <button type="submit" class="btn btn-primary">Proses</button>
                </div>
            </div>
        </form>
        <!-- BY PEGAWAI -->

        <!-- BY DIVISI -->
        <hr>
        <h5 class="hitam"> # Copy Master - Mesin Lain (by divisi)</h5>
        <form action="{% url "cpdivisi" %}" method="post">
            {% csrf_token %}
            <div class="d-flex justify-content-start" style="width: 100%;">
                <div class="" style="width: 100%;">
                    <label for="mesin" class="hitam">Mesin</label>
                    <select name="mesin" class="mesin" id="mesin" >
                        <option value="">Pilih Mesin</option>
                        {% for m in mesin %}
                            <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="divisi" class="hitam">Divisi</label>
                    <select name="divisi[]" class="divisi" id="divisi" >
                        <option value="">Pilih Divisi</option>
                        {% for m in divisi %}
                            <option value="{{m.id}}">{{m.divisi}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="mesint" class="hitam">Mesin Tujuan</label>
                    <select name="mesint[]" class="mesint"  id="mesint" >
                        <option value="">Pilih Mesin Tujuan</option>
                        {% for m in mesin %}
                        <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                &nbsp
                <div class="d-flex align-items-end" style="width: 100%;">
                    <button type="submit" class="btn btn-primary">Proses</button>
                </div>
            </div>
            <hr>
        </form>
        <h5 class="hitam"> # Tambah Data Pegawai Ke Mesin</h5>
        <form action="{% url "tambahdatamesin" %}" method="post">
            {% csrf_token %}
            <div class="d-flex justify-content-start" style="width: 100%;">
                <div class="" style="width: 100%;">
                    <label for="mesin" class="hitam">Mesin</label>
                    <select name="mesin" class="mesin" id="mesin" >
                        <option value="">Pilih Mesin</option>
                        {% for m in mesin %}
                            <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="nama" class="hitam">Nama</label>
                    <input type="text" name="nama" id="nama" class="form-control">
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="userid" class="hitam">Userid</label>
                    <input type="text" name="userid" id="userid" class="form-control">
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="level" class="hitam">Pilih User Level</label>
                    <select name="level" id="level" class="level">
                        <option value="">Pilih Level</option>
                        <option value="1">Admin</option>
                        <option value="0">User</option>
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="password" class="hitam">Password</label>
                    <input type="text" name="password" id="password" class="form-control">
                </div>
                &nbsp
                &nbsp
                <div class="d-flex align-items-end" style="width: 100%;">
                    <button type="submit" class="btn btn-primary">Proses</button>
                </div>
            </div>
            <hr>
        </form>
        <h5 class="hitam"> # Edit Data Ke Mesin</h5>
        <form action="{% url "editdatamesin" %}" method="post">
            {% csrf_token %}
            <div class="d-flex justify-content-start" style="width: 100%;">
                <div class="" style="width: 100%;">
                    <label for="mesin" class="hitam">Mesin</label>
                    <select name="mesin" class="mesin" id="mesin" >
                        <option value="">Pilih Mesin</option>
                        {% for m in mesin %}
                            <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="pegawai" class="hitam">Pegawai</label>
                    <select name="pegawai" id="pegawai" class="pegawais">
                        <option value="">Pilih Pegawai</option>
                        {% for p in pegawai %}
                            <option value="{{p.pk}}">{{p.nama}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="nama" class="hitam">Nama</label>
                    <input type="text" name="nama" id="nama" class="form-control">
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="userid" class="hitam">Userid</label>
                    <input type="text" name="userid" id="userid" class="form-control">
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="level" class="hitam">Pilih User Level</label>
                    <select name="level" id="level" class="level">
                        <option value="">Pilih Level</option>
                        <option value="1">Admin</option>
                        <option value="0">User</option>
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="password" class="hitam">Password</label>
                    <input type="text" name="password" id="password" class="form-control">
                </div>
                &nbsp
                &nbsp
                <div class="d-flex align-items-end" style="width: 100%;">
                    <button type="submit" class="btn btn-primary">Proses</button>
                </div>
            </div>
            <hr>
        </form>
        <h5 class="hitam"> # Hapus Data Di Mesin</h5>
        <form action="{% url "hapusdatamesin" %}" method="post">
            {% csrf_token %}
            <div class="d-flex justify-content-start" style="width: 100%;">
                <div class="" style="width: 100%;">
                    <label for="pegawai" class="hitam">Pegawai</label>
                    <select name="pegawai[]" id="pegawai" class="pegawai">
                        <option value="">Pilih Pegawai</option>
                        {% for p in pegawai %}
                            <option value="{{p.pk}}">{{p.nama}} - {{p.userid}}</option>
                        {% endfor %}
                    </select>
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="mesint" class="hitam">Mesin Tujuan</label>
                    <select name="mesint[]" class="mesint"  id="mesint" >
                        <option value="">Pilih Mesin Tujuan</option>
                        {% for m in mesin %}
                        <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="d-flex align-items-end" style="width: 100%;">
                    <button type="submit" class="btn btn-primary">Proses</button>
                </div>
            </div>
            <hr>
        </form>
        <h5 class="hitam"> # Hapus Data Di Mesin</h5>
        <form action="{% url "hapusdatamesinu" %}" method="post">
            {% csrf_token %}
            <div class="d-flex justify-content-start" style="width: 100%;">
                <div class="" style="width: 100%;">
                    <label for="pegawai" class="hitam">Pegawai</label>
                    <input type="text" class="form-control" name="userid" id="userid">
                </div>
                &nbsp
                <div class="" style="width: 100%;">
                    <label for="mesint" class="hitam">Mesin Tujuan</label>
                    <select name="mesint[]" class="mesint"  id="mesint" >
                        <option value="">Pilih Mesin Tujuan</option>
                        {% for m in mesin %}
                        <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="d-flex align-items-end" style="width: 100%;">
                    <button type="submit" class="btn btn-primary">Proses</button>
                </div>
            </div>
            <hr>
        </form>
        <hr>
        <h5 class="hitam"># Khusus Admin</h5>
        <hr>
        <div id="msgadmin"></div>
        <div id="tableadmin" style="max-height:250px; overflow-y:auto;"></div>
        <h5 class='hitam'># Cari dengan nama</h5>
        <div class="d-flex justify-content-start" style="width: 100%;">
            <div class="" style="width: 100%;">
                <label for="data" class="hitam">Data</label>
                <input type="text" class="form-control" name="data" id="data">
            </div>
            &nbsp
            <div class="" style="width: 100%;">
                <label for="filter" class="hitam">Filter Dengan</label>
                <select name="filter" class="mesin"  id="filter" >
                    <option value="">Pilih Mesin Tujuan</option>
                    <option value="nama">Nama</option>
                    <option value="userid">Userid</option>
                    <option value="uid">UID</option>
                </select>
            </div>
            <div class="" style="width: 100%;">
                <label for="mesinnama" class="hitam">Mesin Tujuan</label>
                <select name="mesinnama[]" class="mesint"  id="mesinnama" >
                    <option value="">Pilih Mesin Tujuan</option>
                    {% for m in mesin %}
                    <option value="{{m.id}}">{{m.nama}} - {{m.ipaddress}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="d-flex align-items-end" style="width: 100%;">
                <button id="byfilter" class="btn btn-primary">Proses</button>
            </div>
        </div>
        <hr>
        <h5 class='hitam'># Tambah ke mesin dengan datamesin</h5>
        <form action="{% url 'adddtmesin' %}" method="post">
            <div class="d-flex justify-content-start" style="width: 100%;">
                <div class="" style="width: 100%;">
                    <label for="dtpegawai" class="hitam">Data Pegawai</label>
                    <select name="dtpegawai[]" class="mesint"  id="dtpegawai" >
                        <option value="">Pilih Data Pegawai</option>
                        {% for dt in datamesin %}
                        <option value="{{dt.id}}">{{dt.nama}} - {{dt.uid}} - {{dt.userid}}</option>
                        {% endfor %}
                    </select>
                    <b class="hitam">Nama - UID - Userid</b>
                </div>
                <div class="" style="width: 100%;">
                    <label for="mesindtmesin" class="hitam">Mesin Tujuan</label>
                    <select name="mesindtmesin[]" class="mesin"  id="mesindtmesin" >
                        <option value="">Pilih Mesin Tujuan</option>
                        {% for m in mesin %}
                        <option value="{{m.ipaddress}}">{{m.nama}} - {{m.ipaddress}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="d-flex align-items-end" style="width: 100%;">
                    <button id="byfilter" class="btn btn-primary">Proses</button>
                </div>
            </div>
        </form>
        <hr>
        <!-- BY DIVISI -->
    <!-- alert berhasil -->
    </div>
</div><!-- br-pagebody -->

{% endblock breadcrumb %}
{% block hrd_ajax %}
    <script>
        $(".mesin").selectize()
        $(".mesint").selectize({
            maxItems:null
        })
        $(".pegawai").selectize({
            maxItems:null,
        })
        $(".pegawais").selectize()
        $(".divisi").selectize({
            maxItems:null,
        })
        $(".level").selectize()
        const token = document.querySelector("input[name=csrfmiddlewaretoken]").value
        $("#byfilter").on("click",function(e){
            $("#msgadmin p").remove()
            $("#tableadmin table").remove()
            const mesin = $("#mesinnama").val() ? $("#mesinnama").val() : undefined
            console.log(mesin)
            const data = $("#data").val() ? $("#data").val() : undefined 
            const filter = $("#filter").val() ? $("#filter").val() : undefined
            $("#msgadmin").append("<p class='alert alert-info'>Proses...</p>")
            $.ajax({
                url:"{% url 'byfilter' %}",
                method:"post",
                data:{mesin,data,filter},
                headers:{"X-CSRFToken":token},
                success:(e) => {
                    $("#msgadmin p").remove()
                    console.log(e)
                    if(e.users){
                        let struser = ''
                        e.users.forEach(dt => {
                            struser += `
                                <tr>    
                                    <td>${dt.uid}</td>
                                    <td>${dt.nama}</td>
                                    <td>${dt.userid}</td>
                                    <td>${dt.level}</td>
                                    <td>${dt.password}</td>
                                    <td>${dt.mesin}</td>
                                </tr>
                            `
                        })
                        $("#tableadmin").append(`
                        <table class="table tx-inverse">
                            <thead class="thead-light">
                                <tr>
                                    <td>UID</td>
                                    <td>Nama</td>
                                    <td>Userid</td>
                                    <td>Privilege</td>
                                    <td>Password</td>
                                    <td>Mesin</td>
                                </tr>
                            </thead>
                            <tbody>
                                ${struser}
                            </tbody>
                        </table>
                    `)
                    }
                    if(e.fingers){
                        let str = ''
                        e.fingers.forEach(dt => {
                            str += `
                                <tr>
                                    <td>${dt.uid}</td>
                                    <td>${dt.fid}</td>
                                    <td>${dt.size}</td>
                                    <td>${dt.mesin}</td>
                                </tr>
                            `
                        })
                        $("#tableadmin").append(`<table class="table tx-inverse">
                            <thead class="thead-light">
                                <tr>
                                    <td>UID</td>
                                    <td>Finger ID</td>
                                    <td>Size</td>
                                    <td>Mesin</td>
                                </tr>
                            </thead>
                            <tbody>
                                ${str}
                            </tbody>

                            </table>`)
                    }

                },
                error:(err) => {
                    $("#msgadmin p").remove()
                    $("#tableadmin table").remove()
                    if(err.responseJSON?.msg){
                        $("#msgadmin").append(`<p class="alert alert-danger">${err.responseJSON.msg}</p>`)
                    }else{
                        $("#msgadmin").append(`<p class="alert alert-danger">Terjadi Kesalahan</p>`)
                    }
                }
            })
        })
    </script>
{% endblock hrd_ajax %}